(()=>{const e=io(),t=document.getElementById("rooms"),n=document.getElementById("messages"),i=document.getElementById("input"),o=document.getElementById("form"),a=document.getElementById("userSearchInput");a.addEventListener("input",h);const d={};function s(e,t){const n=document.getElementById("confirmDialog"),i=document.getElementById("confirmText"),o=document.getElementById("confirmYes"),a=document.getElementById("confirmNo");function d(){n.style.display="none",o.removeEventListener("click",s),a.removeEventListener("click",c)}function s(){d(),t(!0)}function c(){d(),t(!1)}i.textContent=e,n.style.display="flex",o.addEventListener("click",s),a.addEventListener("click",c)}document.getElementById("logoutBtn").addEventListener("click",(()=>{s("Willst du dich wirklich ausloggen?",(e=>{e&&(localStorage.clear(),window.location.href="/")}))}));const c=document.getElementById("menuToggle"),r=document.querySelector(".sidebar");c.addEventListener("click",(()=>{r.classList.toggle("open")}));let l=[];e.on("online users",(e=>{l=e.filter((e=>e!==m))}));let m=localStorage.getItem("username"),u=null;localStorage.getItem("username")||(window.location.href="/"),e.emit("register user",m),a.addEventListener("input",(t=>{const n=t.target.value.trim().toLowerCase();e.emit("search users",n)})),e.on("search results",(e=>{userList.innerHTML="",e.forEach((e=>{const t=document.createElement("li");t.textContent=e,t.addEventListener("click",(()=>{f(e)})),userList.appendChild(t)}))})),document.getElementById("profileName").textContent=m,e.on("update user list",(e=>{l=e,h()})),document.getElementById("fileInput");const g=document.getElementById("profilePic"),p=localStorage.getItem("profilePic");function h(){const e=document.getElementById("userSearchInput"),t=document.getElementById("friendsList");t.innerHTML="";const n=e.value.toLowerCase();l.filter((e=>e.toLowerCase().includes(n)&&e!==m)).forEach((e=>{const n=document.createElement("li");n.style.cursor="pointer",n.style.padding="5px 0",n.textContent=e,n.addEventListener("click",(()=>{f(e),document.getElementById("friendsSection").style.display="none"})),t.appendChild(n)}))}function E(){const e=document.getElementById("friendsSection"),t="block"===e.style.display;e.style.display=t?"none":"block",t||h()}function y(){const t=document.getElementById("privateRoomsList");t.innerHTML="",(JSON.parse(localStorage.getItem("privateRooms"))||[]).forEach((i=>{const o=i.split("-").filter((e=>e!==m))[0]||i,a=document.createElement("li");a.classList.add("room"),a.style.cursor="pointer",a.textContent=o,a.addEventListener("click",(()=>{u=i,n.innerHTML="",e.emit("join room",{username:m,room:i}),document.querySelectorAll(".room").forEach((e=>e.classList.remove("active"))),a.classList.add("active")})),t.appendChild(a)}))}function f(t){const i=[m,t].sort().join("-");u=i,n.innerHTML="",e.emit("join room",{username:m,room:i});let o=JSON.parse(localStorage.getItem("privateRooms"))||[];o.includes(i)||(o.push(i),localStorage.setItem("privateRooms",JSON.stringify(o))),y()}function v(){document.documentElement.style.setProperty("--app-height",`${window.innerHeight}px`)}p&&(g.src=p),t.addEventListener("click",(t=>{const i=t.target.getAttribute("data-room");i&&("Friends"!==i?(document.getElementById("friendsSection").style.display="none",u=i,n.innerHTML="",e.emit("join room",{username:m,room:i}),document.querySelectorAll(".room").forEach((e=>e.classList.remove("active"))),t.target.classList.add("active")):E())})),o.addEventListener("submit",(async t=>{if(t.preventDefault(),!u)return alert("Bitte wähle einen Raum.");const n=i.value.trim(),o=C.files[0];if(!n&&!o)return void alert("Bitte gib eine Nachricht ein oder wähle ein Medium.");const a={username:m,text:n,profilePic:g.src},d=()=>{i.value="",C.value="",w.innerHTML=""};if(!o)return e.emit("chat message",a),void d();if(!["image/png","image/jpeg","video/mp4"].includes(o.type))return alert("Nur PNG, JPG oder MP4 erlaubt!"),void(C.value="");if(o.type.startsWith("video/")){const e=document.createElement("video");return e.preload="metadata",e.onloadedmetadata=async()=>{if(window.URL.revokeObjectURL(e.src),e.duration>120)return alert("Video zu lang! Maximal 2 Minuten."),void(C.value="");await s()},void(e.src=URL.createObjectURL(o))}async function s(){const t=new FormData;t.append("media",o);try{const n=await fetch("/upload",{method:"POST",body:t});if(!n.ok)throw new Error("Upload fehlgeschlagen");const i=await n.json();a.media={type:i.type,url:i.mediaUrl},e.emit("chat message",a),d()}catch(e){alert("Fehler beim Hochladen der Datei."),console.error(e)}}await s()})),e.on("chat message",(e=>{const t=document.createElement("li");t.classList.add("message-item"),t.dataset.id=e.id,t.dataset.username=e.username,t.dataset.text=e.text,d[u]&&document.hidden&&new Notification(`Neue Nachricht in ${room}`,{body:`${e.username}: ${e.text||"Neue Nachricht"}`,icon:e.profilePic});const i=n.children.length;document.getElementById("messageCounter").textContent=`${i} Nachrichten`;const o=document.createElement("div");o.classList.add("message-line");const a=document.createElement("img");a.src=e.profilePic||"default-avatar.png",a.classList.add("message-pic");const s=document.createElement("span");s.classList.add("message-name"),s.textContent=`${e.username}:`;const c=document.createElement("span");if(c.classList.add("message-text"),c.textContent=e.text,e.username===m){const n=document.createElement("button");n.classList.add("msg-actions-btn"),n.innerHTML="⋮",n.title="Aktionen",n.addEventListener("click",(n=>{n.stopPropagation(),M(e.id,e.username,e.text,t)})),o.appendChild(n)}if(e.username===m){const n=document.createElement("button");n.classList.add("msg-actions-btn"),n.innerHTML="⋮",n.title="Aktionen",n.addEventListener("click",(n=>{n.stopPropagation(),M(e.id,e.username,e.text,t)})),o.appendChild(n)}if(o.appendChild(a),o.appendChild(s),e.text&&o.appendChild(c),t.appendChild(o),e.media&&e.media.url){const n=document.createElement("div");n.classList.add("media-message");const i=document.createElement(e.media.type.startsWith("image/")?"img":"video");i.src=e.media.url,e.media.type.startsWith("video/")&&(i.controls=!0),i.style.cursor="pointer",i.addEventListener("click",(()=>k(e.media.url,e.media.type))),n.appendChild(i),t.appendChild(n)}n.appendChild(t),n.scrollTop=n.scrollHeight})),e.on("chat history",(e=>{n.innerHTML="",document.getElementById("roomTitle").textContent=`# ${u}`,document.getElementById("messageCounter").textContent=`${e.length} Nachrichten`,e.forEach((e=>{const t=document.createElement("li");t.classList.add("message-item");const i=document.createElement("div");i.classList.add("message-line");const o=document.createElement("img");o.src=e.profilePic||"default-avatar.png",o.classList.add("message-pic");const a=document.createElement("span");a.classList.add("message-name"),a.textContent=`${e.username}:`;const d=document.createElement("span");if(d.classList.add("message-text"),d.textContent=e.text,e.username===m){const n=document.createElement("button");n.classList.add("msg-actions-btn"),n.innerHTML="⋮",n.title="Aktionen",n.addEventListener("click",(n=>{n.stopPropagation(),M(e.id,e.username,e.text,t)})),i.appendChild(n)}if(i.appendChild(o),i.appendChild(a),e.text&&i.appendChild(d),t.appendChild(i),e.media&&e.media.url){const n=document.createElement("div");n.classList.add("media-message");const i=document.createElement(e.media.type.startsWith("image/")?"img":"video");i.src=e.media.url,e.media.type.startsWith("video/")&&(i.controls=!0),i.style.cursor="pointer",i.addEventListener("click",(()=>k(e.media.url,e.media.type))),n.appendChild(i),t.appendChild(n)}n.appendChild(t)})),n.scrollTop=n.scrollHeight})),document.getElementById("refreshChatBtn").addEventListener("click",(t=>{const i=u;i&&("Friends"!==i?(document.getElementById("friendsSection").style.display="none",n.innerHTML="",e.emit("join room",{username:m,room:i}),document.querySelectorAll(".room").forEach((e=>e.classList.remove("active"))),t.target.classList.add("active")):E())})),document.getElementById("deleteAccountBtn").addEventListener("click",(()=>{s("Willst du wirklich deinen Account und alle deine Nachrichten löschen? Diese Aktion ist unwiderruflich!",(t=>{t&&e.emit("delete account",{username:m})}))})),e.on("account deleted",(()=>{localStorage.clear(),window.location.href="/"})),e.on("reload messages",(()=>{u&&(n.innerHTML="",e.emit("join room",{username:m,room:u}))})),document.addEventListener("DOMContentLoaded",(()=>{y()})),window.addEventListener("resize",v),window.addEventListener("load",v);const L=document.getElementById("profileDialog"),B=document.getElementById("profile"),I=document.getElementById("cancelProfileDialog"),b=document.getElementById("saveProfileChanges");function x(e){const t=document.createElement("div");t.textContent=e,Object.assign(t.style,{position:"fixed",top:"20px",left:"50%",transform:"translateX(-50%)",background:"#4caf50",color:"white",padding:"12px 24px",borderRadius:"8px",boxShadow:"0 0 10px rgba(0,0,0,0.3)",zIndex:"9999",fontSize:"16px",fontWeight:"bold"}),document.body.appendChild(t),setTimeout((()=>t.remove()),3e3)}B.addEventListener("click",(()=>{L.classList.add("open")})),I.addEventListener("click",(()=>{L.classList.remove("open")})),b.addEventListener("click",(async()=>{const t=document.getElementById("editUsername").value.trim(),n=document.getElementById("editPassword").value.trim(),i=document.getElementById("editProfilePic"),o=i.files[0],a=()=>{e.emit("update profile",{oldUsername:m,newUsername:t,newPassword:n}),t&&(localStorage.setItem("username",t),m=t,document.getElementById("profileName").textContent=t),x("Profil erfolgreich aktualisiert!"),L.classList.remove("open")};if(o){if(!["image/png","image/jpeg"].includes(o.type))return alert("Nur PNG und JPG erlaubt!"),void(i.value="");const t=new FileReader;t.onload=function(t){const n=new Image;n.onload=async function(){if(n.width>1e4||n.height>1e4)return alert("Bild zu groß! Maximal 10000x10000 Pixel."),void(i.value="");const t=new FormData;t.append("media",o);try{const n=await fetch(`/upload?username=${m}&profile=true`,{method:"POST",body:t});if(!n.ok)throw new Error("Fehler beim Upload");const i=await n.json();g.src=i.mediaUrl,localStorage.setItem("profilePic",i.mediaUrl),e.emit("update profile picture",{username:m,profilePic:i.mediaUrl}),a()}catch(e){alert("Upload fehlgeschlagen."),console.error(e)}},n.src=t.target.result},t.readAsDataURL(o)}else a()}));const C=document.getElementById("mediaInput"),w=document.getElementById("mediaPreview");function k(e,t){const n=document.createElement("div");n.className="media-fullscreen-overlay";const i=document.createElement(t.startsWith("image/")?"img":"video");i.src=e,t.startsWith("video/")&&(i.controls=!0),n.appendChild(i),document.body.appendChild(n),n.addEventListener("click",(()=>n.remove()))}function M(e,t,n,i){if(t!==m)return;const o=document.createElement("div");o.className="message-action-menu",o.innerHTML=`\n    <button onclick="editMessage('${e}', \`${n.replace(/`/g,"`")}\`)">✏️ Bearbeiten</button>\n    <button onclick="deleteMessage('${e}')">🗑️ Löschen</button>\n  `,i.appendChild(o),setTimeout((()=>document.addEventListener("click",(()=>o.remove()),{once:!0})))}C.addEventListener("change",(()=>{w.innerHTML="";const e=C.files[0];if(!e)return;if(!["image/png","image/jpeg","video/mp4"].includes(e.type))return alert("Nur PNG, JPG oder MP4 erlaubt!"),void(C.value="");if(e.size>104857600)return alert("Datei zu groß! Maximal 5MB."),void(C.value="");const t=new FileReader;t.onload=t=>{const n=document.createElement(e.type.startsWith("image/")?"img":"video");n.src=t.target.result,"VIDEO"===n.tagName&&(n.controls=!0),n.addEventListener("click",(()=>k(n.src,e.type))),w.appendChild(n)},t.readAsDataURL(e)})),n.addEventListener("contextmenu",(e=>{e.preventDefault();const t=e.target.closest(".message-item");if(!t||t.dataset.username!==m)return;const n=document.createElement("div");n.className="context-menu",n.style.top=`${e.clientY}px`,n.style.left=`${e.clientX}px`,n.innerHTML='\n      <button id="editMsg">✏️ Bearbeiten</button>\n      <button id="deleteMsg">🗑️ Löschen</button>\n    ',document.body.appendChild(n);const i=()=>n.remove();setTimeout((()=>window.addEventListener("click",i,{once:!0}))),n.querySelector("#editMsg").onclick=()=>{prompt("Neue Nachricht:",t.dataset.text)&&x("Bearbeiten noch nicht implementiert")},n.querySelector("#deleteMsg").onclick=()=>{confirm("Nachricht löschen?")&&x("Löschen noch nicht implementiert")}})),n.addEventListener("touchstart",(e=>{const t=e.target.closest(".message-item");if(!t||t.dataset.username!==m)return;let n=setTimeout((()=>{confirm("Nachricht bearbeiten oder löschen?")&&x("Mobile Menü noch nicht implementiert")}),600);t.addEventListener("touchend",(()=>clearTimeout(n)),{once:!0})})),e.on("message edited",(({id:e,newText:t})=>{const n=[...document.querySelectorAll(".message-item")].find((t=>t.dataset.id===e));if(n){const e=n.querySelector(".message-text");e&&(e.textContent=t+" ✏️")}})),e.on("message deleted",(({id:e})=>{const t=[...document.querySelectorAll(".message-item")].find((t=>t.dataset.id===e));t&&t.remove()})),document.getElementById("reportBugBtn").addEventListener("click",(()=>{document.getElementById("bugDialog").style.display="block"})),document.getElementById("cancelBug").addEventListener("click",(()=>{document.getElementById("bugDialog").style.display="none",document.getElementById("bugMessage").value=""})),document.getElementById("sendBug").addEventListener("click",(()=>{const e=document.getElementById("bugMessage").value.trim();0===e.length||e.length>500?alert("Bitte eine gültige Nachricht (max. 500 Zeichen) eingeben."):fetch("/report-bug",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:m,message:e})}).then((e=>e.json())).then((e=>{alert(e.message||"Gesendet"),document.getElementById("bugDialog").style.display="none",document.getElementById("bugMessage").value=""})).catch((()=>alert("Fehler beim Senden.")))}))})();